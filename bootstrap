#!/bin/sh
#Generates ./configure, Makefile.in's and tools

# Stop at first error:
set -e
# Print commands:
set -x

if [ "x$1" = xclean ]; then
    test ! -f Makefile || make maintainer-clean || true

    # Generated by aclocal.
    rm -f aclocal.m4
    # Generated by autoheader.
    rm -f config.h.in
    # Generated by autoconf.
    rm -f configure
    rm -rf autom4te.cache/
    # Generated or brought in by automake.
    find -name "Makefile.in" | xargs -r rm
    find autotools/ -type l | xargs -r rm
    exit;
fi

# Gnulib
if [ ! -f gnulib/lib/Makefile.am ]; then
    # Look for gnulib-tool. Use '|| true' because of 'set -e' above
    GNULIB_TOOL=`PATH=gnulib-git:$PATH:/usr/src/gnulib which gnulib-tool \
	|| true`
    if [ -z "$GNULIB_TOOL" ]; then
	git clone git://git.savannah.gnu.org/gnulib.git gnulib-git
	GNULIB_TOOL=./gnulib-git/gnulib-tool
    fi
    $GNULIB_TOOL --source-base=gnulib/lib --m4-base=gnulib/m4 \
	--import
fi

# Enable no-portability to disable GNU make extensions warnings, such as $(shell)
#if autoreconf --install --symlink --warnings=all --warnings=no-portability $*
if autoreconf --install --symlink --warnings=all $*
then echo "You now can run ./configure"
else echo "*** Error: please check the messages above. ***"
fi
