Official list of changes
========================

The v1.08 installer ships with a 'whatsnew.txt' file describing most
if not all changes, described succinctly.


Comprehensive links chronology in the Dink Network message board
================================================================

Development - Dink Smallwood v1.08 - Suggestions
http://www.dinknetwork.com/forum.cgi?MID=48641

Development - The Three Pillars of Dink v1.08
http://www.dinknetwork.com/forum.cgi?MID=52195

General Dink Discussion - Help Test Dink Smallwood v1.08 - Alpha 1 -> 5
http://www.dinknetwork.com/forum.cgi?MID=50116

General Dink Discussion - Dink Smallwood v1.08 Beta 1 Now Available
http://www.dinknetwork.com/forum.cgi?MID=54349

General Dink Discussion - Dink Smallwood v1.08 Beta 2
http://www.dinknetwork.com/forum.cgi?MID=54523

General Dink Discussion - Dink Smallwood v1.08 Beta 3
http://www.dinknetwork.com/forum.cgi?MID=55267

News Comments - New File: Dink Smallwood v1.08 - Release Candidate 1 -> 2
http://www.dinknetwork.com/forum.cgi?MID=57155

News Comments - New File: Dink Smallwood v1.08 - Release Candidate 3
http://www.dinknetwork.com/forum.cgi?MID=57519

News Comments - New File: Dink Smallwood v1.08 - Release Candidate 4
http://www.dinknetwork.com/forum.cgi?MID=57829

News Comments - New File: Dink Smallwood v1.08 - Release Candidate 5
http://www.dinknetwork.com/forum.cgi?MID=58202

News Comments - New File: Dink Smallwood v1.08 - Release Candidate 6
http://www.dinknetwork.com/forum.cgi?MID=59442

News Comments - New File: Dink Smallwood v1.08 - Release Candidate 7
http://www.dinknetwork.com/forum.cgi?MID=59848

News Comments - New File: Dink Smallwood 1.08 Final
http://www.dinknetwork.com/forum.cgi?MID=60436


First version of the compatibility thread:
http://www.dinknetwork.com/forum.cgi?MID=60061

Second version of the compatibility thread:
http://www.dinknetwork.com/forum.cgi?MID=67349


Other sources of information
============================

The v1.08 announcement mentions a plan to reuse all improvements from
the "reDink" version, which are described in its readme_reDink.txt.

The included dinkc.chm has a section "Internal Functions by Version"
with a "v1.08+" entry, describing all added DinkC commands.

Grep //redink1 in the 1.08 source code.

[ ] Paul Jewsbury posted a list of v1.08 bugs he ran into:
    http://www.dinknetwork.com/forum.cgi?MID=89849


Incorporating changes in FreeDink
=================================

I suggest different approaches depending on the kind of fix:

- bug fix with no side effect: apply fix

- bug fix that was exploited in a released D-Mod: don't apply fix in
  v1.07 mode, add in v1.08 mode

- good improvement: apply change

- bad improvement already used in a released D-Mod: apply change in
  v1.08 mode, or if possible, don't apply change at all, and fix the
  D-Mod

- bad improvement never used in a released D-Mod: don't apply change
  and mark as deprecated

- DinkC changes: offer 2 versions of the engine (1.07 and 1.08) as
  well as a new DinkC with a clean syntax, a different file extension,
  and UTF-8 support.


List of changes
===============

whatsnew.txt
------------

Fixes:
[X] Support for windowed mode (-window parameter).
    => this refers to fixing the colors in windowed mode, which SDL
    already provided for us.
[X] Dink moves at a normal (slower) speed on faster computers.
[X] Framerate can no longer exceed 83 FPS (to fix problems with vsync
    disabled).
    => See 2007-09-18 - 2007-09-20 commits; I also improved the code
    for better correctness. See framerate.txt.
[X] The 1-pixel row above the status bar now draws sprite graphics.
    => just playy = 400 instead of 399; fixed 2008-05-22
[X] Scrolling now appears on 1-pixel rows and columns near status bar.
    => fixed 2008-06-08, in 'transition'.
[X] Dink can no longer walk around the edges of the screen during a screenlock.
    => fixed 2008-06-08, with stricter checks because it didn't work
    in all cases.
[X] Removed screenlock on restart game
    => fixed 2008-06-08, in DinkC binding for 'restart_game'.
[X] Dink's speed reset to normal (3) on load to prevent 'hyper-sword' bug.
    => fixed 2008-06-08, in 'load_game'.
[X] Time for save game correctly displayed (2:05 instead of 2:5).
    => fixed 2008-06-08, in 'decipher_string'.
[X] The first tile on the fire and water tile pages animate correctly.
    => fixed 2008-06-08, in 'process_animated_tiles'.
[ ] Dink's map position appears correctly after warps.
[X] Properly exits when closed with Alt-F4.
    => done as part of FreeDink v1.07 clean-up
[ ] Level-up no longer lost if in inventory screen, fixed several other
    experience count issues.
[ ] Status is drawn on load so the magic-level is always displayed.
[ ] Fixed issue of a phantom keyboard key causing the Map to not be displayed.
[ ] ffcreate.exe will only include .bmp files (to prevent the .ff file including itself in an
    infinite loop of hard-drive punishment).
[ ] Restoring game will not redraw status bar if it wasn't drawn.
[X] Fixed issue of loading regular bmp sequences over top of previous sequences
    (before the animation would be 'corrupt')
    => See for further explanation http://www.dinknetwork.com/forum.cgi?MID=92733
    => fixed 2008-05-22, but differently (clean sequence reload)
[ ] Corpses appear as the same size as the living sprite.
    => that is, if an ennemy has a size of 50%, its dead body will
    also have a size of 50% (previously it was 100%)

[X] Dinkedit: several spelling/grammar fixes
[X] Removed extra space in "I'm gesturing wildly to  no avail!"
    => Fixed 2008-06-08

Improvements:
[ ] Support for high-color (-truecolor parameter).
[ ] "dnotalk" script is run if no sprites are around when Dink talks (not
    required).
[ ] "dnomagic" script is run if Dink tries to use magic without arming any (not
    required).

Improvements that potentially break backward compatibility:
[ ] "button4" script is run when the user hits the enter key (not required).
[ ] "button7" through "button10" scripts will be run when extra gamepad buttons
    are pressed.
    => there's a naming conflict: "Edit: Well, that's beautiful... As
    you may or may not be aware, as of 1.08, you can change the
    function of the Enter key in your D-Mod with a script named
    'button4'. Secret of Parizaya just happens to have a script named
    button4, interfering with the Enter key's ability to
    work. Therefore, Secret of Parizaya is currently incompatible with
    1.08. Tada." (http://www.dinknetwork.com/forum.cgi?MID=59442)
[X] Variables can begin with another variable stub (i.e. &goldtemp will work with
    &gold).
    => Implemented conditionally 04-07-2008
[ ] &missle_source is defined for all attacks, not just missiles.
[X] &return is a built-in variable that stores the last return value of any
    function (built-in or custom).
    => Implemented conditionally 04-07-2008
[X] Custom functions can have up to 9 arguments, stored in the built-in variables
    &arg1 through &arg9.
    => Implemented conditionally 04-07-2008

DinkC changes:

Fixes:
[X] playavi(str avifile)
    Removed command.
    => applied unconditionaly 2008-03-09
[X] run_script_by_number(int script, "proc");
    No longer runs a random procedure if it cannot locate proc specified.
    => Fixed 04-07-2008
[X] sp_sound(int sprite, int value)
    Passing a -1 will no longer crash the game.
    => Fixed 2008-07-01

Backward-incompatible fixes:
[ ] compare_magic(str magicitem)
    Works correctly.
[ ] sp_move_x(int sprite, int value)
    Like sp_mx, but does not return a value.
[ ] sp_move_y(int sprite, int value)
    Like sp_my, but does not return a value.
[ ] sp_move_nohard(int sprite, bool value)
    When activated, a sprite can move freely through all hardness.  Previously
    had no effect.

New functions:
[X] clear_editor_info()
    Removes the editor_seq and editor_frame for all sprites on the map.
    => Implemented conditionally 07-07-2008
[X] get_date_day()
    Returns the current day.
[X] get_date_month()
    Returns the current month.
[X] get_date_year()
    Returns the current year.
[ ] get_item(str item)
    Returns first slot of this item.
[ ] get_magic(str magicitem)
    Returns first slot of this magic.
[ ] get_next_sprite_with_this_brain(int brain, int spriteignore, int spritestart)
    Begins searching for brains of type 'brain' starting with 'spritestart'.
[X] get_time_game()
    Returns the number of minutes the player has been playing the game (total).
[X] get_time_real()
    Returns the number of minutes in the day (900 = 3 pm).
[ ] get_truecolor()
    Returns true if the game is in true-color mode.
[ ] load_map(str mapdat, str dinkdat)
    Loads a new map.dat/dink.dat.  Saved and loaded with the save game.
[X] load_palette(str palbmp)
    Loads a new global palette (only works in full screen 256 color mode). Saved
    and loaded with the save game.
    => Implemented conditionally 07-07-2008
[X] load_tile(str tilebmp, int index)
    Loads a new tile set for the given index.  Saved and loaded with the save
    game.
    => Implemented conditionally 07-07-2008
[ ] loopmidi(bool loop)
    If 1, all midis will automatically loop.  If 0, midis will not loop.
[X] make_global_function(str script, str function)
    Allows you to use the specified function in DinkC without the use of
    external.
    => Implemented conditionally 04-07-2008
[X] math_abs(int num)
[X] math_mod(int num1, int num2)
[X] math_sqrt(int num1)
[X] map_hard_tile(int maptile, int hardtileindex)
    Gets or sets the hard tiles on the current map screen.  'maptile' refers to
    the tiles on the current screen from 1 (upper-left corner) to 96
    (lower-right corner).
    => Implemented conditionally 07-07-2008
[X] map_tile(int maptile, int tileindex)
    Gets or sets the tiles on the current map screen.  'maptile' refers to the
    tiles on the current screen from 1 (upper-left corner) to 96 (lower-right
    corner).
    => Implemented conditionally 07-07-2008
[ ] screenlock(int value)
    Returns the current screenlock value if value is -1.
[ ] set_dink_base_push(int dinkbasepush)
    Sets the base-push for Dink.  Default is 310.  Not saved with save games.
[ ] set_font_color(int colorindex, int red, int green, int blue)
    Changes the specified color index to the specified color.
[X] set_save_game_info(str line)
    Sets the line of information to be displayed in the save game summary.  The
    default is "Level &level".
    => Implemented conditionally 07-07-2008
[ ] show_console()
    Shows the console, which accepts DinkC commands as input (Escape to cancel).
[ ] show_inventory()
    Displays the inventory screen.
[X] sp_blood_seq(int sprite, int seq)
    The start of the blood sequences.
    => Implemented conditionally 04-07-2008
[X] sp_blood_num(int sprite, int num)
    How many blood sequences follow sp_blood_seq.
    => Implemented conditionally 04-07-2008
[ ] sp_clip_bottom(int sprite, int pixels)
[ ] sp_clip_left(int sprite, int pixels)
[ ] sp_clip_right(int sprite, int pixels)
[ ] sp_clip_top(int sprite, int pixels)
[X] sp_freeze(int sprite, bool freeze (-1 to return))
    If 1, acts like freeze.  If 0, acts like unfreeze.  -1 will return whether
    the given sprite is frozen or not (basically a better 'busy' function).
[ ] var_used()
    Returns the number of variables used.


dinkc.chm
---------

[ ] entry for hurt():

"In 1.07 and earlier, a negative damage value would cause the game to
freeze.  1.08 and later will ignore the command safely."

=> Actually, I couldn't reproduce the freeze, so v1.08 is essentially
   changing DinkC's behavior: with v1.07 hurt(&sthing, -1) would run
   hit(), with v1.08 it doesn't.


- entry for say():
"Also in 1.07 and earlier, Dink would not interpret lines with a colon
correctly, like so:say("bonus: 5 points", 1); // would not display any
text at all!This issue has also been fixed in 1.08."

- entry for sp_move_nohard():
"In 1.07 and earlier, the move_no_hard value only had an effect when
the active_sprite was actively moving (through move and move_stop
commands). In 1.08+, the move_no_hard value should take effect at all
times."

- entry for show_bmp():
"1.07 had a couple bugs displaying the map dot: it would not be
displayed properly if Dink was warped using DinkC or if he was on the
32nd screen of any row. This has been fixed in 1.08+."

- entry for playavi():
"playavi was removed from 1.08+.  In early development versions of
Dink Smallwood, this command was used to call an external dplay.exe
file to play avi movies. However, this was not implemented in the
final game as it didn't work very well. Before the Dink Smallwood
source code was released, Dan Walma used this command to add
additional features, like changing maps. He released dPlay, a
replacement for dplay.exe. No D-Mods were released that took advantage
of this functionality."


Diffing
-------

Files cannot be diffed directly because the indentation changed.

The best way to get rid of identation differences is to transform
source files into canonical forms and indent them:

# Remove the few lines containing to std::*, which confuse 'indent'
./c_canonicalize.sh a
./c_canonicalize.sh b
diff -u -Bbw a_canonical b_canonical


Diff overview
-------------

- dink.cpp: ~75kB. Numerous references to the console mode, which
  needs to take over input at several points in the code.

- dinkedit.cpp: only a few grammar changes.

- update_frame.cpp: ~7kB. mconsole, framerate, one thing about MIDI,
  and a couple clean-up.

- dinkvar.h: ~190kB. TrueColor mode, scope?, ...


Changes not documented in whatsnew.txt
--------------------------------------

[X] max_idata changed from 600 to 1000; idata store additional sprite
    data during dink.ini initial loading. Some 1.08 D-Mods such as
    "City of Dead" require more than 600 idata, and v1.07 ignores part
    of them, resulting in misplaced sprites.
    => Implemented conditionally 04-07-2008

[ ] added a woe registry key so as to deprecate
    %WINDIR%/dinksmallwood.ini overwrite.

[ ] New DinkC function: set_smooth_follow

[X] Cleaner but backward-incompatible DinkC scope: before, when there
    were 2 identical variables in different scopes (local/global), the
    first memory slot had priority; now, local variables always have
    priority over global variables.
    => Implemented conditionally 04-07-2008

[X] DinkC: Added "/=" alternative to "/". However, there's a potential
    bug there, because the script cursor is moved 1 character forward
    in both case, instead of 2 for "/=" (that's what's done for
    "*="). "*=" is also added in the v1.08 patch, except that it was
    already present in v1.07 and checked before in the code, so this
    doesn't have any effect.
    => Implemented conditionally 04-07-2008

[X] When a sprite hits another, the reference sprite for the blood is
    now the sprite that _was_ hit, not the one who hits. This is most
    useful with v1.08 sprite-specific blood, it's not really
    noticeable in v1.07.


Compilation
===========

The readme.txt says that you need VS.NET or VS2005. The 'Express'
version from MS won't work, because it only support console and .net
applications (eg. it's doesn't provide windows.h).

Trying to compile with VC++6 triggers lots of C++ template errors and
one undefined DDLOCK_DONOTWAIT symbol, plus loads of warnings about
truncated mangled names. I haven't put much work into it.


Forsaken changes
================

* Dynamic (shell- and Perl4-style) scope in DinkC (referenced in "The
  Three Pillars of Dink v1.08" link above)


Non-changes
===========

[?] Variables are no longer shared between two instances of the same
    script.
    => Unless I'm mistaken, this is already the case in v1.07.
    Local ones, at least.
