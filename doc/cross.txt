Cross-compilation # -*- shell-script -*-
=================

# Install a cross-compiler version of GCC
aptitude install mingw32

# To store cross-compiled libraries
mkdir -p -m 775 /usr/local/cross-tools/i386-mingw32msvc
# SDL uses 'i386-mingw32', but the real canonical name is
# i386-mingw32msvc, used by e.g. 'SDL_gfx'. So let's make a symlink:
ln -s i386-mingw32msvc /usr/local/cross-tools/i386-mingw32
# To store source tarballs that will be distributed along with static
# binaries to comply with the GNU GPL and LGPL
mkdir -m 755 /usr/src/depsources


Cross-compile yourself
----------------------

That is necessary for static builds (no static libraries are provided
with the official releases). If feeling lazy and ok with .dlls, check
"Install precompiled SDL binaries" below.

# SDL
VERSION=1.2.13
cd /usr/src/
# Get non-free DX headers from libsdl.org
wget -P depsources/ http://www.libsdl.org/extras/win32/common/directx-devel.tar.gz
tar xzf depsources/directx-devel.tar.gz -C /usr/local/cross-tools/i386-mingw32msvc/
wget http://libsdl.org/release/SDL-$VERSION.tar.gz
tar xzf SDL-$VERSION.tar.gz
mv SDL-$VERSION.tar.gz depsources/
cd SDL-$VERSION
CPPFLAGS="-I /usr/local/cross-tools/i386-mingw32msvc/include" \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu
# if you don't want stdout.txt and stderr.txt to be created:
#  --disable-stdio-redirect
# note: no need for -L, mingw already has libdsound.a, etc.
# Alternative: get free DX headers from libwine
# Unfortunately SDL fails to compile as of 2008-08-06 :/
#aptitude install libwine-dev
#CPPFLAGS="-I /usr/include/wine/windows"
make
make install # /usr/local/cross-tools/i386-mingw32/ by default

# SDL_mixer
VERSION=1.2.8
cd /usr/src/
wget -P depsources/ http://libsdl.org/projects/SDL_mixer/release/SDL_mixer-$VERSION.tar.gz
tar xzf depsources/SDL_mixer-$VERSION.tar.gz
cd SDL_mixer-$VERSION
# Disable MP3 support (not needed in FreeDink and avoid a dependency)
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config ./configure \
  --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --disable-music-mp3
make
make install # /usr/local/cross-tools/i386-mingw32/ by default

# SDL_ttf - dep1: FreeType
VERSION=2.3.7
cd /usr/src/
wget -P depsources/ http://download.savannah.gnu.org/releases/freetype/freetype-$VERSION.tar.bz2
tar xjf depsources/freetype-$VERSION.tar.bz2
cd freetype-$VERSION
# Enable bytecode interpreter, that's what distros use most, and we
# need it for compatibility in font metrics. It's disabled by default
# for fear of patent attacks.
# Check:
# - http://freetype.org/patents.html
# - http://bugs.debian.org/447801
# - freetype-2.3.5/docs/TRUETYPE
sed -i -e 's,/\* #define TT_CONFIG_OPTION_BYTECODE_INTERPRETER \*/,#define TT_CONFIG_OPTION_BYTECODE_INTERPRETER,' \
    include/freetype/config/ftoption.h
./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install

# SDL_ttf
VERSION=2.0.9
cd /usr/src/
wget -P depsources/ http://libsdl.org/projects/SDL_ttf/release/SDL_ttf-$VERSION.tar.gz
tar xzf depsources/SDL_ttf-$VERSION.tar.gz
cd SDL_ttf-$VERSION
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config \
  FREETYPE_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/freetype-config \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu
make
make install # /usr/local/cross-tools/i386-mingw32/ by default

# SDL_gfx
VERSION=2.0.17
cd /usr/src
wget -P depsources/ http://www.ferzkopp.net/Software/SDL_gfx-2.0/SDL_gfx-$VERSION.tar.gz
tar xzf depsources/SDL_gfx-$VERSION.tar.gz
cd SDL_gfx-$VERSION
# Build system patches sent to the author, hopefully they will make to
# 2.0.18 :)
patch -p1 < ~/freedink/doc/SDL_gfx-patches/asm_gcc4.3.diff
patch -p1 < ~/freedink/doc/SDL_gfx-patches/libtool_crosscompile.diff
patch -p1 < ~/freedink/doc/SDL_gfx-patches/libtool_static.diff
patch -p1 < ~/freedink/doc/SDL_gfx-patches/asm_win32_nomingw.diff
# Rebuild patched build system (make sure you have libtool)
autoreconf --force --install --symlink
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu
make
make install # /usr/local/cross-tools/i386-mingw32msvc/ by default

# SDL_image - dep1: JPEG
cd /usr/src/
wget -P depsources/ http://www.ijg.org/files/jpegsrc.v6b.tar.gz
tar xzf depsources/jpegsrc.v6b.tar.gz
cd jpeg-6b
CC=i586-mingw32msvc-gcc RANLIB=i586-mingw32msvc-ranlib \
  ./configure \
  --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install-lib
# Shared build: would need to reliboolize, recreate configure.ac. The
# sources from Debian do not appear to support cross-compilation to
# mingw either - just a standard Unix build.
#  --enable-shared
## Need to do a lot of things manually:
#CC=i586-mingw32msvc-gcc RANLIB=i586-mingw32msvc-ranlib \
#  ./ltconfig ltmain.sh i586-mingw32msvc
##(From the Debian package:)
#cat <<'EOF' > libtool
##!/bin/bash
#exec libtool "$@"
#EOF
#chmod 755 libtool
##ln -fs /usr/share/libtool/ltmain.sh
#make
#make install
# See also http://gnuwin32.sourceforge.net/packages/jpeg.htm
#          http://gnuwin32.sourceforge.net/downlinks/jpeg-src-zip.php
#          (/src/jpeg/6b/jpeg-6b/Makefile - custom build system)

# TODO: libpng and libtiff
# http://www.libpng.org/pub/png/libpng.html
# http://www.remotesensing.org/libtiff/

# SDL_image
# (not used now, but may be in the future)
VERSION=1.2.6
cd /usr/src/
wget -P depsources/ http://libsdl.org/projects/SDL_image/release/SDL_image-$VERSION.tar.gz
tar xzf depsources/SDL_image-$VERSION.tar.gz
cd SDL_image-$VERSION
# Apply security patch from forgot-to-release 1.2.7
aptitude install subversion
svn diff -c3462 http://svn.libsdl.org/trunk/SDL_image/IMG_gif.c | patch -p0
svn diff -c3462 http://svn.libsdl.org/trunk/SDL_image/SDL_image.h | patch -p0
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config \
  CPPFLAGS="-I /usr/local/cross-tools/i386-mingw32msvc/include" \
  ./configure \
  --host=i586-mingw32msvc --build=i686-pc-linux-gnu
make
make install # /usr/local/cross-tools/i386-mingw32/ by default

# libzip - dep1: zlib
VERSION=1.2.3
cd /usr/src
wget -P depsources/ http://www.gzip.org/zlib/zlib-$VERSION.tar.gz
tar xzf depsources/zlib-$VERSION.tar.gz
cd zlib-$VERSION
CC=i586-mingw32msvc-gcc LD=i586-mingw32msvc-ld \
  AR="i586-mingw32msvc-ar r" \
  RANLIB="i586-mingw32msvc-ranlib" \
  ./configure --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install
# TODO: --shared doesn't work, it says I should not set CC - but I
# need it for cross-compilation. Then they say we should try libtool -
# how about using it directly then? ;)
# Maybe check:
# http://gnuwin32.sourceforge.net/packages/zlib.htm
# http://gnuwin32.sourceforge.net/downlinks/zlib-src-zip.php
# (non-trivial Makefile patch - direct, not Makefile.in)
# (src/zlib/1.2.3/zlib-1.2.3/patches/zlib-1.2.3.diff)

# libzip
VERSION=0.9
cd /usr/src/
wget -P depsources/ http://www.nih.at/libzip/libzip-$VERSION.tar.gz
tar xzf depsources/libzip-$VERSION.tar.gz
cd libzip-$VERSION/
CPPFLAGS="-I/usr/local/cross-tools/i386-mingw32msvc/include" \
  LDFLAGS="-L/usr/local/cross-tools/i386-mingw32msvc/lib" \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
    --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install

# pkgconfig (used to detect ziplib and zzip in the build system)
VERSION=0.23
cd /usr/src/
wget -P depsources/ http://pkgconfig.freedesktop.org/releases/pkg-config-$VERSION.tar.gz
tar xzf depsources/pkg-config-$VERSION.tar.gz
cd pkg-config-$VERSION
./configure --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install
ln -s /usr/local/cross-tools/i386-mingw32msvc/bin/pkg-config \
  /usr/local/bin/i586-mingw32msvc-pkg-config
# or set
# PKG_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/pkg-config


Cross-compile FreeDink
----------------------

aptitude install upx-ucl 
cd ~/freedink/
mkdir cross
cd cross/
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config \
  ../configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --enable-static --with-upx
make install-strip DESTDIR=`pwd`/destdir
ls -lh destdir/usr/local/bin/*.exe


Install precompiled SDL binaries
--------------------------------

VERSION=1.2.13
# Cf. http://libsdl.org/download-1.2.php
wget http://libsdl.org/release/SDL-devel-$VERSION-mingw32.tar.gz
tar xzf SDL-devel-$VERSION-mingw32.tar.gz
mv SDL-$VERSION/* i386-mingw32msvc/
rmdir SDL-$VERSION

# Install precompiled SDL_mixer binaries
VERSION=1.2.8
wget http://libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-$VERSION-VC8.zip
unzip SDL_mixer-devel-$VERSION-VC8.zip
cp -r SDL_mixer-$VERSION/include/* i386-mingw32msvc/include/SDL/
cp -r SDL_mixer-$VERSION/lib/* i386-mingw32msvc/lib/
rm -rf SDL_mixer-$VERSION/

# Install precompiled SDL_ttf binaries
VERSION=2.0.9
wget http://libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-$VERSION-VC8.zip
unzip SDL_ttf-devel-$VERSION-VC8.zip
cp -r SDL_ttf-$VERSION/include/* i386-mingw32msvc/include/SDL/
cp -r SDL_ttf-$VERSION/lib/* i386-mingw32msvc/lib/
rm -rf SDL_ttf-$VERSION/

# (Install precompiled SDL_image binaries)
VERSION=1.2.6
wget http://libsdl.org/projects/SDL_image/release/SDL_image-devel-$VERSION-VC8.zip
unzip SDL_image-devel-$VERSION-VC8.zip
cp -r SDL_image-$VERSION/include/* i386-mingw32msvc/include/SDL/
\cp -r SDL_image-$VERSION/lib/* i386-mingw32msvc/lib/
rm -rf SDL_image-$VERSION/

# Cross-compile SDL_gfx (no binaries available)
# (see above)

# Cross-compile libzip (no binaries available)
# (see above)

See also http://www.gtk.org/download-windows.html which has links to
various binaries and dev packages for Windows.


Details on static build
-----------------------

I want to cross-compile statically, to provide a single .exe that
includes SDL and SDL_* :)

- You specify -static

- You add -lwinmm

i586-mingw32msvc-gcc mousetest.c \
  `/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config --cflags \
  --static-libs` -lwinmm

- If you have some troubles with SDL_gfx which tries to use
  __imp__SDL_setFramerate, you need a build system patch (see above) -
  maybe it will make it to 2.0.18 ;)

- You add -lfreetype, a dependency of SDL_ttf

You get a 1.1MB standalone stripped executable.

Now directly available with:
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config \
   ../configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
   --enable-static ...


Misc
----

Those may be used later on.

# zziplib 0.12
wget http://dfn.dl.sourceforge.net/sourceforge/zziplib/zziplib-0.12.83.tar.bz2
CPPFLAGS="-I/usr/local/cross-tools/i386-mingw32msvc/include" \
  LDFLAGS="-L/usr/local/cross-tools/i386-mingw32msvc/lib" \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
    --prefix=/usr/local/cross-tools/i386-mingw32msvc
# avoid compiling bins/ which has compilation errors:
cd i586-pc-mingw32msvc/zzip
make
make install
# I think I remember it crashes under woe?

# zziplib 0.13
wget http://ovh.dl.sourceforge.net/sourceforge/zziplib/zziplib-0.13.49.tar.bz2
# --disable-mmap because of compilation errors in zzip/mmapped.c
CPPFLAGS="-I/usr/local/cross-tools/i386-mingw32msvc/include" \
  LDFLAGS="-L/usr/local/cross-tools/i386-mingw32msvc/lib" \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
    --prefix=/usr/local/cross-tools/i386-mingw32msvc --disable-mmap
make
# => doesn't work, it tries to use ftello which is apparently missing from mingw

# Guile - dep1: libltdl
VERSION=2.2.4
http://ftp.gnu.org/pub/gnu/libtool/libtool-$VERSION.tar.bz2
tar xjf libtool-$VERSION.tar.bz2 
cd libtool-$VERSION
./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install

# Guile - dep2: GNU MP
VERSION=4.2.2
wget ftp://ftp.gnu.org/gnu/gmp/gmp-$VERSION.tar.bz2
tar xjf gmp-$VERSION.tar.bz2
cd gmp-$VERSION
./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install

# Guile
VERSION=1.8.5
http://ftp.gnu.org/pub/gnu/guile/guile-$VERSION.tar.gz
tar xzf guile-$VERSION.tar.gz
cd guile-$VERSION
CPPFLAGS="-I/usr/local/cross-tools/i386-mingw32msvc/include" \
  LDFLAGS="-L/usr/local/cross-tools/i386-mingw32msvc/lib" \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
    --prefix=/usr/local/cross-tools/i386-mingw32msvc \
    --disable-shared
make
make install

Some problems need to be fixed:

- Comment obsolete AC_SYS_RESTARTABLE_SYSCALLS in configure.in, plus
  refresh ./configure by running 'autoconf'

- Replace '#ifndef tzname' with '#ifndef HAVE_DECL_TZNAME' in
  libguile/stime.c

- Comment '# define SCM_IMPORT 1' in libguile/guile.c

See:
http://lists.gnu.org/archive/html/bug-guile/2008-05/msg00016.html


# libffi (could be used to simplify DinkC bindings)
VERSION=3.0.5
wget ftp://sourceware.org/pub/libffi/libffi-$VERSION.tar.gz
tar xzf libffi-$VERSION.tar.gz
cd libffi-$VERSION
./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install
#i586-mingw32msvc-gcc test.c `/usr/local/cross-tools/i386-mingw32/bin/pkg-config --cflags --libs libffi`

# SDL_stretch (alternative to SDL_gfx that has more accurate scaling,
# but this this is being fixed in SDL_gfx)
wget http://kent.dl.sourceforge.net/sourceforge/sdl-stretch/SDL_stretch-0.2.3.tar.bz2
tar xjf SDL_stretch-0.2.3.tar.bz2  # 07 Dec 2003...
cd SDL_stretch-0.2.3
...lots errors...


See also
--------

http://gnuwin32.sourceforge.net/ distributes precompiled binaries with
static and shared libraries. The binaries are created using MinGW but
from Windows, so they are not cross-compiled. There is no well-defined
source format, and rebuilding binaries can be difficult because they
can rely on heavily modified gnuwin32-specific build system, and on a
set of helpers (http://gnuwin32.sourceforge.net/compile.html). So
binary packages are probably fine to use as-is. Source instructions
however are not always reusable for cross-compiling by our own means.

http://www.profv.de/mingw_cross_env/ provides a scripted way to
cross-build various libraries (static only though).

http://www.profv.de/debian/ repackages gnuwin32 binaries under the
.deb format for easy installation in a cross-compilation
environment. Again this is fine to use as-is but there is no
recompilation nor instructions for re(cross)compilation.
